{% extends 'base.html' %}
{% load static %}

{% block title %}Quản Lý Ứng Viên - Job Portal{% endblock %}

{% block extra_css %}
<style>
    /* Card styling */
    .applicant-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }
    
    .applicant-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    /* Status-based card styling */
    .applicant-card.status-pending {
        border-left-color: #ffc107;
    }
    .applicant-card.status-reviewed {
        border-left-color: #17a2b8;
    }
    .applicant-card.status-shortlisted {
        border-left-color: #007bff;
    }
    .applicant-card.status-rejected {
        border-left-color: #dc3545;
    }
    .applicant-card.status-hired {
        border-left-color: #28a745;
    }
    
    /* Status badge styling */
    .status-badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
        border-radius: 30px;
        font-weight: 500;
        letter-spacing: 0.3px;
    }
    
    /* Button styling */
    .applicant-action-btn {
        transition: all 0.2s;
        border-radius: 6px;
    }
    
    .applicant-action-btn:hover {
        transform: translateY(-2px);
    }
    
    /* Form styling */
    .status-update-form {
        display: inline-block;
    }
    
    .status-options {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }
    
    /* Applicant info styling */
    .applicant-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .applicant-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background-color: #f0f2f5;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #6c757d;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        border: 2px solid #fff;
    }
    
    /* Search and filter styling */
    .search-filter-container {
        position: relative;
        margin-bottom: 20px;
    }
    
    .search-icon {
        position: absolute;
        left: 15px;
        top: 12px;
        color: #6c757d;
    }
    
    .search-input {
        padding-left: 40px;
        border-radius: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border: 1px solid #e9ecef;
        height: 46px;
        transition: all 0.3s ease;
    }
    
    .search-input:focus {
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.15);
        border-color: #c2dbff;
    }
    
    .filter-dropdown {
        border-radius: 30px;
        border: 1px solid #e9ecef;
        height: 46px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        cursor: pointer;
        background-position: right 15px center;
        padding-left: 15px;
    }
    
    .filter-dropdown:focus {
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.15);
        border-color: #c2dbff;
    }
    
    /* Cover letter styling */
    .cover-letter-content {
        max-height: 300px;
        overflow-y: auto;
        background-color: #f8f9fa;
        padding: 18px;
        border-radius: 8px;
        border: 1px solid #eaecef;
        font-size: 0.95rem;
        line-height: 1.6;
    }
    
    .note-input {
        resize: none;
        height: 100px;
        border-radius: 8px;
        padding: 12px;
        transition: all 0.3s ease;
    }
    
    .note-input:focus {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Status change buttons */
    .btn-disabled {
        opacity: 0.5;
        cursor: not-allowed !important;
    }
    
    /* Tooltip styling */
    .tooltip-container {
        position: relative;
        display: inline-block;
    }
    
    .status-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 100;
        display: none;
        margin-bottom: 5px;
    }
    
    .tooltip-container:hover .status-tooltip {
        display: block;
    }
    
    /* Animation */
    .shake-animation {
        animation: shake 0.5s;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    /* Stats cards */
    .stats-card {
        border-radius: 10px;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    
    .stats-number {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 0.2rem;
    }
    
    .stats-label {
        font-size: 0.85rem;
        font-weight: 500;
        color: #6c757d;
    }
    
    /* Glass effect for filters */
    .glass-filter-container {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'employer_dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">Quản Lý Ứng Viên</li>
        </ol>
    </nav>

    <div class="row mb-4">
        <div class="col-md-7">
            <h2 class="mb-0 d-flex align-items-center">
                <i class="bi bi-people-fill me-2 text-primary"></i>
                <span>Danh Sách Ứng Viên</span>
            </h2>
            <div class="d-flex align-items-center mt-2">
                <span class="badge bg-primary rounded-pill me-2 py-1 px-2">{{ job.title }}</span>
                <span class="text-muted">{{ applications|length }} ứng viên đã nộp hồ sơ</span>
            </div>
        </div>
        <div class="col-md-5 text-end">
            <div class="d-flex justify-content-end gap-2">
                <form method="post" action="{% url 'applicant_tracking' job.id %}" id="autoRejectForm" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="auto_reject" value="true">
                    <button type="button" class="btn btn-warning px-3" id="btnAutoReject" data-bs-toggle="tooltip" data-bs-placement="top" title="Tự động đánh giá CV ứng viên dựa trên yêu cầu công việc và từ chối những ứng viên với điểm số dưới 5/10">
                        <i class="bi bi-robot me-1"></i>Tự Động Đánh Giá
                    </button>
                </form>
                <a href="{% url 'job_detail' job.id %}" class="btn btn-outline-primary px-3">
                    <i class="bi bi-eye me-1"></i>Xem Chi Tiết Công Việc
                </a>
            </div>
        </div>
    </div>

    {% if applications %}
        <div class="card glass-filter-container mb-4">
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-5">
                        <div class="search-filter-container mb-0">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" id="applicant-search" class="form-control search-input" placeholder="Tìm kiếm theo tên, email...">
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="row">
                            <div class="col-md-6">
                                <select id="status-filter" class="form-select filter-dropdown">
                                    <option value="">Tất cả trạng thái</option>
                                    <option value="pending">Đang chờ</option>
                                    <option value="reviewed">Đã xem xét</option>
                                    <option value="shortlisted">Trong danh sách rút gọn</option>
                                    <option value="rejected">Đã từ chối</option>
                                    <option value="hired">Đã tuyển dụng</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <select id="sort-applications" class="form-select filter-dropdown">
                                    <option value="newest">Mới nhất trước</option>
                                    <option value="oldest">Cũ nhất trước</option>
                                    <option value="name">Sắp xếp theo tên</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-2 col-sm-4 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body py-3">
                        <div class="stats-number text-primary" id="count-all">{{ applications|length }}</div>
                        <div class="stats-label">Tổng số</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body py-3">
                        <div class="stats-number text-warning" id="count-pending">{{ applications.pending_count|default:"0" }}</div>
                        <div class="stats-label">Đang chờ</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body py-3">
                        <div class="stats-number text-info" id="count-reviewed">{{ applications.reviewed_count|default:"0" }}</div>
                        <div class="stats-label">Đã xem xét</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body py-3">
                        <div class="stats-number text-primary" id="count-shortlisted">{{ applications.shortlisted_count|default:"0" }}</div>
                        <div class="stats-label">Shortlisted</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body py-3">
                        <div class="stats-number text-danger" id="count-rejected">{{ applications.rejected_count|default:"0" }}</div>
                        <div class="stats-label">Từ chối</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body py-3">
                        <div class="stats-number text-success" id="count-hired">{{ applications.hired_count|default:"0" }}</div>
                        <div class="stats-label">Tuyển dụng</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="applicants-container">
            {% for application in applications %}
            <div class="card applicant-card mb-3 status-{{ application.status }}" data-status="{{ application.status }}" data-name="{{ application.applicant.first_name }} {{ application.applicant.last_name }}" data-email="{{ application.applicant.email }}" data-date="{{ application.created_at|date:'Y-m-d' }}">
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="applicant-info">
                                <div class="applicant-avatar">
                                    {% if application.applicant.profile_picture %}
                                    <img src="{{ application.applicant.profile_picture.url }}" alt="{{ application.applicant.first_name }}" class="img-fluid" width="64" height="64">
                                    {% else %}
                                    <i class="bi bi-person"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <h5 class="mb-1 fw-bold">{{ application.applicant.first_name }} {{ application.applicant.last_name }}</h5>
                                    <p class="text-muted mb-1">
                                        <i class="bi bi-envelope-fill me-1 small"></i>{{ application.applicant.email }}
                                    </p>
                                    <div class="small text-muted">
                                        <i class="bi bi-calendar3 me-1"></i>Nộp: {{ application.created_at|date:"d/m/Y" }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <div class="d-flex flex-column justify-content-center h-100">
                                <div class="status-badge-container mb-2 d-flex align-items-center">
                                    <span class="status-badge badge {% if application.status == 'pending' %}bg-warning
                                    {% elif application.status == 'reviewed' %}bg-info
                                    {% elif application.status == 'shortlisted' %}bg-primary
                                    {% elif application.status == 'rejected' %}bg-danger
                                    {% elif application.status == 'hired' %}bg-success{% endif %}">
                                        {{ application.get_status_display }}
                                    </span>
                                </div>
                                <div class="status-options mt-2">
                                    <div class="tooltip-container status-action-container" data-current-status="{{ application.status }}" data-target-status="pending">
                                        <form method="post" action="{% url 'update_application_status' application.id %}" class="status-update-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="status" value="pending">
                                            <button type="submit" class="btn btn-sm btn-outline-warning status-change-btn">
                                                <i class="bi bi-hourglass-split me-1"></i>Đang chờ
                                            </button>
                                        </form>
                                        <div class="status-tooltip">Không thể chuyển trạng thái</div>
                                    </div>
                                    <div class="tooltip-container status-action-container" data-current-status="{{ application.status }}" data-target-status="reviewed">
                                        <form method="post" action="{% url 'update_application_status' application.id %}" class="status-update-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="status" value="reviewed">
                                            <button type="submit" class="btn btn-sm btn-outline-info status-change-btn">
                                                <i class="bi bi-check-circle me-1"></i>Đã xem xét
                                            </button>
                                        </form>
                                        <div class="status-tooltip">Không thể chuyển trạng thái</div>
                                    </div>
                                    <div class="tooltip-container status-action-container" data-current-status="{{ application.status }}" data-target-status="shortlisted">
                                        <form method="post" action="{% url 'update_application_status' application.id %}" class="status-update-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="status" value="shortlisted">
                                            <button type="submit" class="btn btn-sm btn-outline-primary status-change-btn">
                                                <i class="bi bi-star me-1"></i>Shortlisted
                                            </button>
                                        </form>
                                        <div class="status-tooltip">Không thể chuyển trạng thái</div>
                                    </div>
                                    <div class="tooltip-container status-action-container" data-current-status="{{ application.status }}" data-target-status="rejected">
                                        <form method="post" action="{% url 'update_application_status' application.id %}" class="status-update-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="status" value="rejected">
                                            <button type="submit" class="btn btn-sm btn-outline-danger status-change-btn">
                                                <i class="bi bi-x-circle me-1"></i>Từ chối
                                            </button>
                                        </form>
                                        <div class="status-tooltip">Không thể chuyển trạng thái</div>
                                    </div>
                                    <div class="tooltip-container status-action-container" data-current-status="{{ application.status }}" data-target-status="hired">
                                        <form method="post" action="{% url 'update_application_status' application.id %}" class="status-update-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="status" value="hired">
                                            <button type="submit" class="btn btn-sm btn-outline-success status-change-btn">
                                                <i class="bi bi-check2-all me-1"></i>Tuyển dụng
                                            </button>
                                        </form>
                                        <div class="status-tooltip">Không thể chuyển trạng thái</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-5">
                            <div class="d-flex align-items-center justify-content-end h-100">
                                <div class="action-buttons">
                                    {% if application.resume or application.applicant.resume %}
                                    <a href="{% if application.resume %}{% url 'view_application_resume' application.id %}{% else %}{{ application.applicant.resume.url }}{% endif %}" 
                                       class="btn btn-outline-primary applicant-action-btn me-2" target="_blank">
                                        <i class="bi bi-file-earmark-text me-1"></i>Xem CV
                                    </a>
                                    {% endif %}
                                    <button type="button" class="btn btn-outline-info applicant-action-btn me-2 view-cover-letter" data-id="{{ application.id }}" data-bs-toggle="modal" data-bs-target="#coverLetterModal-{{ application.id }}">
                                        <i class="bi bi-envelope me-1"></i>Thư Ứng Tuyển
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary applicant-action-btn" data-bs-toggle="modal" data-bs-target="#applicantDetailsModal-{{ application.id }}">
                                        <i class="bi bi-three-dots me-1"></i>Chi Tiết
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="coverLetterModal-{{ application.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content border-0 shadow">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-envelope me-2"></i>
                                Thư Ứng Tuyển - {{ application.applicant.first_name }} {{ application.applicant.last_name }}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="cover-letter-content">
                                {{ application.cover_letter|linebreaks }}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle me-1"></i>Đóng
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="applicantDetailsModal-{{ application.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content border-0 shadow">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-person-badge me-2"></i>
                                Thông Tin Chi Tiết - {{ application.applicant.first_name }} {{ application.applicant.last_name }}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm mb-4">
                                        <div class="card-header bg-light py-3">
                                            <h6 class="mb-0"><i class="bi bi-person-fill me-2"></i>Thông Tin Cá Nhân</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <strong>Họ và tên:</strong> {{ application.applicant.first_name }} {{ application.applicant.last_name }}
                                            </div>
                                            <div class="mb-3">
                                                <strong>Email:</strong> {{ application.applicant.email }}
                                            </div>
                                            <div class="mb-3">
                                                <strong>Số điện thoại:</strong> {{ application.applicant.phone_number|default:"Chưa cung cấp" }}
                                            </div>
                                            <div class="mb-3">
                                                <strong>Địa chỉ:</strong> {{ application.applicant.address|default:"Chưa cung cấp" }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm mb-4">
                                        <div class="card-header bg-light py-3">
                                            <h6 class="mb-0"><i class="bi bi-briefcase-fill me-2"></i>Thông Tin Ứng Tuyển</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <strong>Vị trí ứng tuyển:</strong> {{ job.title }}
                                            </div>
                                            <div class="mb-3">
                                                <strong>Ngày nộp hồ sơ:</strong> {{ application.created_at|date:"d/m/Y H:i" }}
                                            </div>
                                            <div class="mb-3">
                                                <strong>Trạng thái:</strong> 
                                                <span class="badge {% if application.status == 'pending' %}bg-warning
                                                {% elif application.status == 'reviewed' %}bg-info
                                                {% elif application.status == 'shortlisted' %}bg-primary
                                                {% elif application.status == 'rejected' %}bg-danger
                                                {% elif application.status == 'hired' %}bg-success{% endif %}">
                                                    {{ application.get_status_display }}
                                                </span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Cập nhật lần cuối:</strong> {{ application.updated_at|date:"d/m/Y H:i" }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm mb-4">
                                        <div class="card-header bg-light py-3">
                                            <h6 class="mb-0"><i class="bi bi-envelope-fill me-2"></i>Thư Ứng Tuyển</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="cover-letter-content">
                                                {{ application.cover_letter|linebreaks }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm mb-4">
                                        <div class="card-header bg-light py-3">
                                            <h6 class="mb-0"><i class="bi bi-journal-text me-2"></i>Ghi Chú</h6>
                                        </div>
                                        <div class="card-body">
                                            <textarea class="form-control note-input" id="note-{{ application.id }}" placeholder="Thêm ghi chú về ứng viên này...">{{ application.employer_notes }}</textarea>
                                            <button class="btn btn-primary mt-3 w-100 save-note" data-id="{{ application.id }}">
                                                <i class="bi bi-save me-1"></i>Lưu Ghi Chú
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="d-flex justify-content-between w-100">
                                <div>
                                    {% if application.resume or application.applicant.resume %}
                                    <a href="{% if application.resume %}{% url 'view_application_resume' application.id %}{% else %}{{ application.applicant.resume.url }}{% endif %}" 
                                       class="btn btn-primary" target="_blank">
                                        <i class="bi bi-file-earmark-text me-1"></i>Xem CV
                                    </a>
                                    {% endif %}
                                </div>
                                <div>
                                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                                        <i class="bi bi-x-circle me-1"></i>Đóng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

    {% else %}
        <div class="alert alert-info">
            <p class="mb-0"><i class="bi bi-info-circle me-2"></i> Chưa có ứng viên nào nộp hồ sơ cho công việc này.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Auto-reject confirmation with improved UI
        const autoRejectBtn = document.getElementById('btnAutoReject');
        const autoRejectForm = document.getElementById('autoRejectForm');
        
        if (autoRejectBtn && autoRejectForm) {
            autoRejectBtn.addEventListener('click', function() {
                if (confirm('Bạn có chắc chắn muốn sử dụng chức năng tự động đánh giá và từ chối?\n\nHệ thống sẽ đánh giá điểm CV của các ứng viên đang ở trạng thái "Đang chờ" so với yêu cầu công việc. Những ứng viên có điểm dưới 5/10 sẽ được tự động chuyển sang trạng thái "Từ chối".\n\nQuá trình này có thể mất một ít thời gian.')) {
                    // Show loading overlay with improved styling
                    const loadingOverlay = document.createElement('div');
                    loadingOverlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center';
                    loadingOverlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    loadingOverlay.style.zIndex = '9999';
                    loadingOverlay.innerHTML = `
                        <div class="card p-4 text-center border-0 shadow" style="max-width: 400px; border-radius: 10px;">
                            <div class="spinner-border text-primary mb-3 mx-auto" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5 class="mb-2">Đang đánh giá CV</h5>
                            <p class="text-muted mb-0">Vui lòng đợi trong giây lát</p>
                        </div>
                    `;
                    document.body.appendChild(loadingOverlay);
                    
                    // Submit the form
                    autoRejectForm.submit();
                }
            });
        }
        
        // Status transition management
        const validTransitions = {
            'pending': ['reviewed', 'shortlisted', 'rejected'],
            'reviewed': ['shortlisted', 'rejected'],
            'shortlisted': ['hired', 'rejected'],
            'rejected': [],
            'hired': []
        };

        const statusMessages = {
            'pending': 'Đang chờ',
            'reviewed': 'Đã xem xét',
            'shortlisted': 'Đã vào danh sách rút gọn',
            'rejected': 'Đã từ chối',
            'hired': 'Đã tuyển dụng'
        };

        // Apply transition rules to status buttons
        const statusContainers = document.querySelectorAll('.status-action-container');
        statusContainers.forEach(container => {
            const currentStatus = container.getAttribute('data-current-status');
            const targetStatus = container.getAttribute('data-target-status');
            const button = container.querySelector('.status-change-btn');
            const tooltip = container.querySelector('.status-tooltip');
            const form = container.querySelector('form');

            if (currentStatus === targetStatus) {
                button.classList.add('btn-disabled');
                button.disabled = true;
                tooltip.textContent = 'Đã ở trạng thái này';
            } else if (!validTransitions[currentStatus].includes(targetStatus)) {
                button.classList.add('btn-disabled');
                if (currentStatus === 'rejected') {
                    tooltip.textContent = 'Không thể thay đổi sau khi đã từ chối';
                } else if (currentStatus === 'hired') {
                    tooltip.textContent = 'Không thể thay đổi sau khi đã tuyển dụng';
                } else {
                    tooltip.textContent = `Không thể chuyển từ ${statusMessages[currentStatus]} sang ${statusMessages[targetStatus]}`;
                }

                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    button.classList.add('shake-animation');
                    
                    // Show a toast notification instead of alert
                    const toastContainer = document.createElement('div');
                    toastContainer.style.position = 'fixed';
                    toastContainer.style.top = '20px';
                    toastContainer.style.right = '20px';
                    toastContainer.style.zIndex = '9999';
                    
                    const toast = document.createElement('div');
                    toast.className = 'toast show';
                    toast.setAttribute('role', 'alert');
                    toast.setAttribute('aria-live', 'assertive');
                    toast.setAttribute('aria-atomic', 'true');
                    toast.innerHTML = `
                        <div class="toast-header bg-danger text-white">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong class="me-auto">Không thể thay đổi trạng thái</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            ${tooltip.textContent}
                        </div>
                    `;
                    
                    toastContainer.appendChild(toast);
                    document.body.appendChild(toastContainer);
                    
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => {
                            document.body.removeChild(toastContainer);
                        }, 300);
                    }, 5000);
                    
                    setTimeout(() => {
                        button.classList.remove('shake-animation');
                    }, 500);
                });
            }
        });

        // Search and filter functionality
        const searchInput = document.getElementById('applicant-search');
        if (searchInput) {
            searchInput.addEventListener('input', filterApplicants);
            
            // Add clear button to search input
            const searchContainer = searchInput.parentElement;
            const clearButton = document.createElement('button');
            clearButton.className = 'btn btn-sm position-absolute end-0 top-50 translate-middle-y me-2';
            clearButton.innerHTML = '<i class="bi bi-x-circle"></i>';
            clearButton.style.display = 'none';
            clearButton.style.zIndex = '5';
            clearButton.style.backgroundColor = 'transparent';
            clearButton.style.color = '#6c757d';
            
            clearButton.addEventListener('click', function() {
                searchInput.value = '';
                this.style.display = 'none';
                filterApplicants();
                searchInput.focus();
            });
            
            searchInput.addEventListener('input', function() {
                clearButton.style.display = this.value ? 'block' : 'none';
            });
            
            searchContainer.appendChild(clearButton);
        }
        
        const statusFilter = document.getElementById('status-filter');
        if (statusFilter) {
            statusFilter.addEventListener('change', filterApplicants);
        }
        
        const sortSelect = document.getElementById('sort-applications');
        if (sortSelect) {
            sortSelect.addEventListener('change', sortApplicants);
        }
        
        // Save notes functionality with improved feedback
        const saveNoteButtons = document.querySelectorAll('.save-note');
        saveNoteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const applicationId = this.getAttribute('data-id');
                const noteInput = document.getElementById(`note-${applicationId}`);
                const note = noteInput.value;
                
                // Save original button text
                const originalButtonText = button.innerHTML;
                
                // Show loading state
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Đang lưu...';

                const csrftoken = getCookie('csrftoken');

                fetch(`{% url 'save_application_note' application_id=0 %}`.replace('0', applicationId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ note })
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(data => {
                    if (data.status === 'success') {
                        // Show success state
                        button.classList.remove('btn-primary');
                        button.classList.add('btn-success');
                        button.innerHTML = '<i class="bi bi-check-circle me-1"></i>Đã lưu thành công';
                        
                        // Add visual feedback to the textarea
                        noteInput.style.borderColor = '#28a745';
                        noteInput.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';
                        
                        // Reset after delay
                        setTimeout(() => {
                            button.classList.remove('btn-success');
                            button.classList.add('btn-primary');
                            button.innerHTML = originalButtonText;
                            button.disabled = false;
                            
                            noteInput.style.borderColor = '';
                            noteInput.style.boxShadow = '';
                        }, 2000);
                    } else {
                        showErrorState();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showErrorState();
                });
                
                function showErrorState() {
                    // Show error state
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-danger');
                    button.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Lỗi khi lưu';
                    
                    // Reset after delay
                    setTimeout(() => {
                        button.classList.remove('btn-danger');
                        button.classList.add('btn-primary');
                        button.innerHTML = originalButtonText;
                        button.disabled = false;
                    }, 2000);
                }
            });
        });
        
        // Improved status update confirmation
        const statusForms = document.querySelectorAll('.status-update-form');
        statusForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const statusValue = this.querySelector('input[name="status"]').value;
                const button = this.querySelector('button');
                
                if (button.classList.contains('btn-disabled')) {
                    e.preventDefault();
                    return false;
                }
                
                if (statusValue === 'rejected' || statusValue === 'hired') {
                    const applicantCard = this.closest('.applicant-card');
                    const applicantName = applicantCard.querySelector('h5').textContent;
                    const statusText = statusValue === 'rejected' ? 'từ chối' : 'tuyển dụng';
                    
                    // Prevent default to handle with custom confirm dialog
                    e.preventDefault();
                    
                    // Create a custom confirm dialog
                    const modalId = 'confirmModal' + Date.now();
                    const confirmModal = document.createElement('div');
                    confirmModal.className = 'modal fade';
                    confirmModal.id = modalId;
                    confirmModal.setAttribute('tabindex', '-1');
                    confirmModal.setAttribute('aria-hidden', 'true');
                    
                    confirmModal.innerHTML = `
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-0 shadow">
                                <div class="modal-header ${statusValue === 'rejected' ? 'bg-danger' : 'bg-success'} text-white">
                                    <h5 class="modal-title">
                                        <i class="bi bi-${statusValue === 'rejected' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
                                        Xác nhận thay đổi trạng thái
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-4">
                                    <p>Bạn có chắc muốn đánh dấu ứng viên <strong>"${applicantName}"</strong> là <strong>"${statusText}"</strong> không?</p>
                                    <p class="mb-0 small text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Lưu ý: Hành động này sẽ gửi email thông báo đến ứng viên.
                                    </p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
                                    <button type="button" class="btn ${statusValue === 'rejected' ? 'btn-danger' : 'btn-success'}" id="confirmAction">
                                        <i class="bi bi-${statusValue === 'rejected' ? 'x-circle' : 'check2-all'} me-1"></i>
                                        Xác nhận ${statusText}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(confirmModal);
                    
                    // Initialize and show the modal
                    const modal = new bootstrap.Modal(document.getElementById(modalId));
                    modal.show();
                    
                    // Handle confirm action
                    document.getElementById('confirmAction').addEventListener('click', () => {
                        modal.hide();
                        // Add a slight delay to allow modal to close
                        setTimeout(() => {
                            form.submit();
                        }, 300);
                    });
                    
                    // Clean up modal after hiding
                    document.getElementById(modalId).addEventListener('hidden.bs.modal', function () {
                        document.body.removeChild(confirmModal);
                    });
                }
            });
        });
        
        // Animated applicant filtering
        function filterApplicants() {
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const selectedStatus = statusFilter ? statusFilter.value : '';
            
            const applicantCards = document.querySelectorAll('.applicant-card');
            
            applicantCards.forEach(card => {
                const name = card.getAttribute('data-name').toLowerCase();
                const email = card.getAttribute('data-email').toLowerCase();
                const status = card.getAttribute('data-status');
                
                const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
                const matchesStatus = selectedStatus === '' || status === selectedStatus;
                
                // Animate the filtering
                if (matchesSearch && matchesStatus) {
                    card.style.display = '';
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 10);
                } else {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        card.style.display = 'none';
                    }, 300);
                }
            });
            
            updateVisibleCounts();
        }
        
        // Enhanced sorting with animation
        function sortApplicants() {
            const container = document.querySelector('.applicants-container');
            const cards = Array.from(container.querySelectorAll('.applicant-card'));
            const sortBy = sortSelect.value;
            
            // Prepare all cards for animation
            cards.forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(-10px)';
            });
            
            // Sort the cards
            cards.sort((a, b) => {
                if (sortBy === 'newest') {
                    return new Date(b.getAttribute('data-date')) - new Date(a.getAttribute('data-date'));
                } else if (sortBy === 'oldest') {
                    return new Date(a.getAttribute('data-date')) - new Date(b.getAttribute('data-date'));
                } else if (sortBy === 'name') {
                    return a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'));
                }
                return 0;
            });
            
            // Insert the sorted cards with staggered animation
            setTimeout(() => {
                cards.forEach((card, index) => {
                    container.appendChild(card);
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 50);
                });
            }, 300);
        }
        
        // Update count display
        function updateVisibleCounts() {
            const visibleCards = document.querySelectorAll('.applicant-card:not([style*="display: none"])');
            document.getElementById('count-all').textContent = visibleCards.length;
            
            document.getElementById('count-pending').textContent = 
                document.querySelectorAll('.applicant-card[data-status="pending"]:not([style*="display: none"])').length;
            
            document.getElementById('count-reviewed').textContent = 
                document.querySelectorAll('.applicant-card[data-status="reviewed"]:not([style*="display: none"])').length;
            
            document.getElementById('count-shortlisted').textContent = 
                document.querySelectorAll('.applicant-card[data-status="shortlisted"]:not([style*="display: none"])').length;
            
            document.getElementById('count-rejected').textContent = 
                document.querySelectorAll('.applicant-card[data-status="rejected"]:not([style*="display: none"])').length;
            
            document.getElementById('count-hired').textContent = 
                document.querySelectorAll('.applicant-card[data-status="hired"]:not([style*="display: none"])').length;
        }
        
        // Utility function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Add transitions for applicant cards
        document.querySelectorAll('.applicant-card').forEach(card => {
            card.style.transition = 'all 0.3s ease';
        });
        
        // Initialize animations
        sortApplicants();
    });
</script>
{% endblock %}
